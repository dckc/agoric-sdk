name: ag-solo on xs

on: [push]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1
    - name: cache node modules
      uses: actions/cache@v1
      with:
        path: ~/.cache/yarn
        key: ${{ runner.os }}-node-${{ hashFiles('**/yarn.lock') }}
    - name: yarn install
      run: yarn install
    - name: yarn build
      run: yarn build
    - name: cache Modddable SDK
      uses: actions/cache@v1
      with:
        path: moddable
        key: ${{ runner.os }}-moddable-ag04
    - name: install moddable SDK with x-cli-lin platform
      run: |
        test -d moddable || curl -L https://github.com/dckc/moddable/archive/ag04.tar.gz | tar xzf -
        test -d moddalbe || mv moddable-ag04 moddable
    - name: build moddable tools
      run: |
        export MODDABLE=$PWD/moddable
        export XS_DIR=$MODDABLE/xs
        cd $MODDABLE/build/makefiles/lin
        # debug
        # ISSUE: why are debug tools needed?
        make -f $XS_DIR/makefiles/lin/xsc.mk
        make -f $XS_DIR/makefiles/lin/xsid.mk
        make -f $XS_DIR/makefiles/lin/xsl.mk
        make -f tools.mk
        # release
        make GOAL=release -f $XS_DIR/makefiles/lin/xsc.mk
        make GOAL=release -f $XS_DIR/makefiles/lin/xsid.mk
        make GOAL=release -f $XS_DIR/makefiles/lin/xsl.mk
        make GOAL=release -f tools.mk
        export PATH=$MODDABLE/build/bin/lin/release:$PATH
        cd $MODDABLE/examples/helloworld
        mcconfig -m -p x-cli-lin
        # ISSUE: support scripts with no main()?
        # $MODDABLE/build/bin/lin/release/helloworld
